```
┌─────────────────────────────────────────────────────────────────────────┐
│                    📤 USER UPLOAD INVOICE                                │
│                    "mau-hoa-don-mtt.jpg"                                 │
└────────────────────────────────┬────────────────────────────────────────┘
                                 │
                                 ▼
         ┌───────────────────────────────────────────────────┐
         │  🔍 BƯỚC 1: OCR EXTRACTION                        │
         │                                                   │
         │  • Tesseract hoặc Azure Document Intelligence    │
         │  • Extract text: 992 characters                  │
         │  • Extract fields: invoice_code, amount, v.v.    │
         │  • Confidence: 49.9% (Tesseract)                 │
         │                                                   │
         │  Result:                                          │
         │  {                                                │
         │    "invoice_code": "1C23MYY",                    │
         │    "total_amount": "280.000",                    │
         │    "buyer_name": "CPIIOANGLON",                  │
         │    "raw_ocr_text": "Lap hoa don..."             │
         │  }                                                │
         └────────────────┬──────────────────────────────────┘
                          │
          ┌───────────────┼───────────────┐
          │               │               │
          ▼               ▼               ▼
┌─────────────────┐ ┌─────────────┐ ┌─────────────────┐
│  💾 STORAGE 1   │ │ 💾 STORAGE 2│ │  💾 STORAGE 3   │
│  LOCAL FILES    │ │ POSTGRESQL  │ │  CHROMADB RAG   │
└─────────────────┘ └─────────────┘ └─────────────────┘
          │               │               │
          ▼               ▼               ▼


┌──────────────────────────────────────────────────────────────────────────┐
│  💾 STORAGE 1: LOCAL FILE SYSTEM                                         │
├──────────────────────────────────────────────────────────────────────────┤
│  Location: f:\DoAnCN\fastapi_backend\uploads\                           │
│                                                                          │
│  Files:                                                                  │
│  ├── ocr_6a947157-66b4-4cf1-9aa8-97dbe31b7c5d.jpg  ← Original image    │
│  ├── ocr_4849a399-5ef6-46c8-ac61-4743b28feff9.png                       │
│  └── ocr_xxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx.jpg                          │
│                                                                          │
│  Persistent: ✅ YES (files on disk)                                      │
│  Size: ~150KB per invoice                                               │
│  Retention: Permanent (unless manually deleted)                         │
└──────────────────────────────────────────────────────────────────────────┘


┌──────────────────────────────────────────────────────────────────────────┐
│  💾 STORAGE 2: POSTGRESQL DATABASE                                       │
├──────────────────────────────────────────────────────────────────────────┤
│  Database: chatbotdb                                                     │
│  Table: document_storage                                                 │
│                                                                          │
│  Schema:                                                                 │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ id: 7                                                            │   │
│  │ file_name: "mau-hoa-don-mtt.jpg"                                │   │
│  │ file_path: "uploads/ocr_6a947157-66b4-4cf1-9aa8.jpg"           │   │
│  │ azure_url: null                                                  │   │
│  │ ocr_results: {                                                   │   │
│  │   "invoice_code": "1C23MYY",                                    │   │
│  │   "total_amount": "280.000",                                    │   │
│  │   "buyer_name": "CPIIOANGLON",                                  │   │
│  │   "raw_ocr_text": "Lap hoa don CONGTYCPIIOANGLON..."           │   │
│  │ }                                                                │   │
│  │ extracted_data: {                                                │   │
│  │   "invoice_code": "1C23MYY",                                    │   │
│  │   "buyer_name": "CPIIOANGLON",                                  │   │
│  │   "total_amount": "280.000"                                     │   │
│  │ }                                                                │   │
│  │ document_type: "invoice"                                         │   │
│  │ upload_session: "54e8114596587c43"                              │   │
│  │ created_at: 2025-10-03 10:30:15                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  Query Examples:                                                         │
│  • SELECT * FROM document_storage WHERE id = 7;                         │
│  • SELECT COUNT(*) FROM document_storage;                               │
│  • SELECT * FROM document_storage ORDER BY created_at DESC LIMIT 10;   │
│                                                                          │
│  Persistent: ✅ YES (database permanent storage)                         │
│  Indexing: id, file_name, upload_session                               │
└──────────────────────────────────────────────────────────────────────────┘


┌──────────────────────────────────────────────────────────────────────────┐
│  💾 STORAGE 3: CHROMADB VECTOR DATABASE (RAG)                            │
├──────────────────────────────────────────────────────────────────────────┤
│  Location: f:\DoAnCN\fastapi_backend\chroma_db\                         │
│  Collection: invoice_rag_collection                                     │
│  Model: paraphrase-multilingual-MiniLM-L12-v2 (384 dimensions)         │
│                                                                          │
│  Document Structure:                                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ id: "doc_7_chunk_0"                                              │   │
│  │                                                                   │   │
│  │ embedding: [                                                      │   │
│  │   0.123, -0.456, 0.789, 0.234, ...  (384 numbers)               │   │
│  │ ]                                                                 │   │
│  │                                                                   │   │
│  │ document: """                                                     │   │
│  │   Invoice: 1C23MYY                                               │   │
│  │   Buyer: CPIIOANGLON                                             │   │
│  │   Seller: CÔNG TY CP HOÀNG LONG                                  │   │
│  │   Amount: 280.000                                                │   │
│  │   Type: template_sample                                          │   │
│  │                                                                   │   │
│  │   Full OCR Text:                                                 │   │
│  │   Lap hoa don CONGTYCPIIOANGLON...                              │   │
│  │ """                                                               │   │
│  │                                                                   │   │
│  │ metadata: {                                                       │   │
│  │   "source": "chat_upload",                                       │   │
│  │   "session": "54e8114596587c43",                                │   │
│  │   "invoice_code": "1C23MYY",                                    │   │
│  │   "filename": "mau-hoa-don-mtt.jpg"                             │   │
│  │ }                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  Search Example:                                                         │
│  User query: "xem hóa đơn 1C23MYY"                                      │
│  ↓                                                                       │
│  Embedding: [0.456, -0.123, ...]                                        │
│  ↓                                                                       │
│  Cosine similarity with stored embeddings                               │
│  ↓                                                                       │
│  Result: doc_7_chunk_0 (similarity: 0.92) ← Found!                     │
│                                                                          │
│  Persistent: ✅ YES (ChromaDB saves to disk)                             │
│  Index: Vector similarity (HNSW algorithm)                              │
│  Total Documents: 3                                                     │
│  Total Chunks: 3                                                        │
└──────────────────────────────────────────────────────────────────────────┘


┌──────────────────────────────────────────────────────────────────────────┐
│  ☁️ OPTIONAL STORAGE 4: AZURE BLOB STORAGE                               │
├──────────────────────────────────────────────────────────────────────────┤
│  Status: ⚠️ NOT CONFIGURED (hiện tại)                                    │
│                                                                          │
│  When Configured:                                                        │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ Container: chat-documents                                        │   │
│  │ Blob Name: 54e8114596587c43/uuid.jpg                            │   │
│  │ Public URL:                                                      │   │
│  │   https://doancn.blob.core.windows.net/                         │   │
│  │   chat-documents/54e8114596587c43/uuid.jpg                      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│  Purpose: Cloud backup, multi-server access                             │
│  Persistent: ✅ YES (cloud storage)                                      │
│  Cost: ~$0.02/GB/month                                                  │
└──────────────────────────────────────────────────────────────────────────┘


┌──────────────────────────────────────────────────────────────────────────┐
│  🔍 DATA RETRIEVAL FLOW                                                  │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  User Query: "xem hóa đơn 1C23MYY"                                      │
│       │                                                                  │
│       ▼                                                                  │
│  ┌──────────────────────────────────────┐                              │
│  │  Chatbot Pattern Matching            │                              │
│  │  Detect: "xem hóa đơn" intent        │                              │
│  └───────────────┬──────────────────────┘                              │
│                  │                                                       │
│                  ▼                                                       │
│  ┌──────────────────────────────────────┐                              │
│  │  RAG Semantic Search                 │                              │
│  │  Query embedding → ChromaDB          │                              │
│  │  Find similar documents              │                              │
│  └───────────────┬──────────────────────┘                              │
│                  │                                                       │
│                  ▼                                                       │
│  ┌──────────────────────────────────────┐                              │
│  │  Found: doc_7                        │                              │
│  │  Similarity: 0.92                    │                              │
│  └───────────────┬──────────────────────┘                              │
│                  │                                                       │
│                  ▼                                                       │
│  ┌──────────────────────────────────────┐                              │
│  │  PostgreSQL Query                    │                              │
│  │  SELECT * FROM document_storage      │                              │
│  │  WHERE id = 7                        │                              │
│  └───────────────┬──────────────────────┘                              │
│                  │                                                       │
│                  ▼                                                       │
│  ┌──────────────────────────────────────┐                              │
│  │  AI Response with Context            │                              │
│  │  "Tìm thấy hóa đơn 1C23MYY           │                              │
│  │   Người mua: CPIIOANGLON             │                              │
│  │   Tổng tiền: 280.000 VNĐ"           │                              │
│  └──────────────────────────────────────┘                              │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘


┌──────────────────────────────────────────────────────────────────────────┐
│  ✅ SUMMARY - DỮ LIỆU CÓ LƯU KHÔNG?                                      │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  CÓ! Lưu vào 3 nơi:                                                     │
│                                                                          │
│  ✅ Local Files      → Original images                                  │
│  ✅ PostgreSQL       → Structured data + OCR JSON                       │
│  ✅ ChromaDB         → Embeddings for semantic search                   │
│  ⚠️ Azure (optional) → Cloud backup                                     │
│                                                                          │
│  Tất cả đều PERSISTENT (không mất khi restart)                          │
│                                                                          │
│  Total Storage per Invoice:                                             │
│  • File: ~150KB                                                         │
│  • PostgreSQL: ~5KB (JSON)                                              │
│  • ChromaDB: ~2KB (embedding)                                           │
│  = ~157KB per invoice                                                   │
│                                                                          │
│  1000 invoices = ~157MB                                                 │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```
