# 🌐 Azure Storage API Architecture

## LUỒNG DỮ LIỆU HOÀN CHỈNH

```
╔═══════════════════════════════════════════════════════════════════════════════╗
║                         UPLOAD FLOW (Lưu hóa đơn)                             ║
╚═══════════════════════════════════════════════════════════════════════════════╝

    👤 User                 🖥️ Frontend              🔧 Backend               ☁️ Azure
     │                          │                        │                       │
     │  Upload invoice.png      │                        │                       │
     ├─────────────────────────>│                        │                       │
     │                          │  POST /chat/upload     │                       │
     │                          ├───────────────────────>│                       │
     │                          │                        │  upload_image_to_azure│
     │                          │                        ├──────────────────────>│
     │                          │                        │                       │
     │                          │                        │<──────────────────────┤
     │                          │                        │  ✅ Azure URL          │
     │                          │                        │                       │
     │                          │                        │  Save to PostgreSQL   │
     │                          │                        ├───────────────────┐   │
     │                          │                        │  DocumentStorage  │   │
     │                          │                        │  - id: 9          │   │
     │                          │                        │  - filename       │   │
     │                          │                        │  - file_path      │   │
     │                          │                        │<──────────────────┘   │
     │                          │                        │                       │
     │                          │  {"document_id": 9}    │                       │
     │                          │<───────────────────────┤                       │
     │  ✅ Upload success       │                        │                       │
     │<─────────────────────────┤                        │                       │
     │                          │                        │                       │


╔═══════════════════════════════════════════════════════════════════════════════╗
║                     DOWNLOAD FLOW (Lấy hóa đơn)                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝

    👤 User                 🖥️ Frontend              🔧 Backend               ☁️ Azure
     │                          │                        │                       │
     │  Click "Download #9"     │                        │                       │
     ├─────────────────────────>│                        │                       │
     │                          │  GET /download-invoice/9                      │
     │                          ├───────────────────────>│                       │
     │                          │                        │  Query PostgreSQL     │
     │                          │                        ├───────────────────┐   │
     │                          │                        │  SELECT file_path │   │
     │                          │                        │  WHERE id = 9     │   │
     │                          │                        │<──────────────────┘   │
     │                          │                        │  file_path="sess_abc/uuid.png"
     │                          │                        │                       │
     │                          │                        │  get_blob_download_url│
     │                          │                        ├──────────────────────>│
     │                          │                        │                       │
     │                          │                        │  Generate SAS token   │
     │                          │                        │  (expires in 1h)      │
     │                          │                        │<──────────────────────┤
     │                          │                        │  Secure URL + token   │
     │                          │                        │                       │
     │                          │  {"download_url": "https://...?SAS"}          │
     │                          │<───────────────────────┤                       │
     │                          │                        │                       │
     │                          │  Download directly from Azure (bypass backend)│
     │                          ├──────────────────────────────────────────────>│
     │                          │                        │                       │
     │                          │<──────────────────────────────────────────────┤
     │  ⚡ Fast download        │  File bytes            │                       │
     │<─────────────────────────┤                        │                       │
     │                          │                        │                       │


╔═══════════════════════════════════════════════════════════════════════════════╗
║                     LIST FLOW (Danh sách hóa đơn)                             ║
╚═══════════════════════════════════════════════════════════════════════════════╝

    👤 User                 🖥️ Frontend              🔧 Backend               ☁️ Azure
     │                          │                        │                       │
     │  View invoice list       │                        │                       │
     ├─────────────────────────>│                        │                       │
     │                          │  GET /list-invoices    │                       │
     │                          ├───────────────────────>│                       │
     │                          │                        │  Query PostgreSQL     │
     │                          │                        ├───────────────────┐   │
     │                          │                        │  SELECT * FROM    │   │
     │                          │                        │  document_storage │   │
     │                          │                        │  ORDER BY date    │   │
     │                          │                        │<──────────────────┘   │
     │                          │                        │  [doc1, doc2, doc3]   │
     │                          │                        │                       │
     │                          │                        │  For each document:   │
     │                          │                        │  generate_sas_url()   │
     │                          │                        ├──────────────────────>│
     │                          │                        │<──────────────────────┤
     │                          │                        │  URL1, URL2, URL3     │
     │                          │                        │  (expires 24h)        │
     │                          │                        │                       │
     │                          │  {"invoices": [{id, filename, download_url}, ...]}
     │                          │<───────────────────────┤                       │
     │                          │                        │                       │
     │  📄 Display gallery      │                        │                       │
     │  with thumbnails         │                        │                       │
     │<─────────────────────────┤                        │                       │
     │                          │                        │                       │


╔═══════════════════════════════════════════════════════════════════════════════╗
║              PREVIEW FLOW (Xem trước base64)                                  ║
╚═══════════════════════════════════════════════════════════════════════════════╝

    👤 User                 🖥️ Frontend              🔧 Backend               ☁️ Azure
     │                          │                        │                       │
     │  Click "Preview #9"      │                        │                       │
     ├─────────────────────────>│                        │                       │
     │                          │  POST /get-invoice-content/9                  │
     │                          ├───────────────────────>│                       │
     │                          │                        │  Query PostgreSQL     │
     │                          │                        │  → file_path          │
     │                          │                        │                       │
     │                          │                        │  download_blob_content│
     │                          │                        ├──────────────────────>│
     │                          │                        │<──────────────────────┤
     │                          │                        │  File bytes (163KB)   │
     │                          │                        │                       │
     │                          │                        │  Convert to base64    │
     │                          │                        │  ┌──────────────────┐ │
     │                          │                        │  │ iVBORw0KGgo...   │ │
     │                          │                        │  └──────────────────┘ │
     │                          │                        │                       │
     │                          │  {"data_url": "data:image/png;base64,..."}    │
     │                          │<───────────────────────┤                       │
     │                          │                        │                       │
     │  🖼️ Display in <img>    │                        │                       │
     │  (no download needed)    │                        │                       │
     │<─────────────────────────┤                        │                       │
     │                          │                        │                       │
```

---

## 3-TIER STORAGE ARCHITECTURE

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        🌐 USER INTERFACE                                    │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐                   │
│  │ Upload   │  │ List     │  │ Download │  │ Preview  │                   │
│  │ Invoice  │  │ Invoices │  │ File     │  │ Image    │                   │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘                   │
└───────┼─────────────┼─────────────┼─────────────┼─────────────────────────┘
        │             │             │             │
        │             │             │             │
┌───────▼─────────────▼─────────────▼─────────────▼─────────────────────────┐
│                       🔧 BACKEND APIs                                       │
│  ┌────────────────────────────────────────────────────────────────────┐   │
│  │  FastAPI Routes                                                     │   │
│  │  • POST /chat/upload                                                │   │
│  │  • GET  /chat/list-invoices                                         │   │
│  │  • GET  /chat/download-invoice/{id}                                 │   │
│  │  • POST /chat/get-invoice-content/{id}                              │   │
│  └────┬───────────────────────────────────────┬────────────────────────┘   │
└───────┼───────────────────────────────────────┼────────────────────────────┘
        │                                       │
        │                                       │
┌───────▼───────────────────────────────────────▼────────────────────────────┐
│                    💾 3-TIER STORAGE SYSTEM                                 │
│                                                                             │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────────┐     │
│  │  Tier 1:         │  │  Tier 2:         │  │  Tier 3:             │     │
│  │  LOCAL FILES     │  │  POSTGRESQL      │  │  AZURE BLOB          │     │
│  │  (Temporary)     │  │  (Metadata)      │  │  (Permanent)         │     │
│  ├──────────────────┤  ├──────────────────┤  ├──────────────────────┤     │
│  │ uploads/         │  │ document_storage │  │ chat-documents/      │     │
│  │  ├─ ocr_uuid1.png│  │  ├─ id: 9        │  │  ├─ session_abc/    │     │
│  │  ├─ ocr_uuid2.png│  │  ├─ filename     │  │  │   └─ uuid1.png   │     │
│  │  └─ ocr_uuid3.png│  │  ├─ file_path    │  │  ├─ session_def/    │     │
│  │                  │  │  ├─ invoice_type │  │  │   └─ uuid2.png   │     │
│  │ ⚠️  Mất khi      │  │  ├─ uploaded_at  │  │  └─ session_ghi/    │     │
│  │ restart server   │  │  └─ session_id   │  │      └─ uuid3.png   │     │
│  │                  │  │                  │  │                      │     │
│  │ Purpose:         │  │ Purpose:         │  │ Purpose:             │     │
│  │ • OCR processing │  │ • Search/filter  │  │ • Long-term storage  │     │
│  │ • Temp storage   │  │ • Metadata query │  │ • File serving       │     │
│  │                  │  │ • RAG indexing   │  │ • Backup/redundancy  │     │
│  └──────────────────┘  └──────────────────┘  └──────────────────────┘     │
│         ↑                       ↑                       ↑                  │
│         │                       │                       │                  │
│    File bytes            blob_name mapping       File bytes + SAS         │
└─────────┼───────────────────────┼───────────────────────┼──────────────────┘
          │                       │                       │
          │                       │                       │
┌─────────▼───────────────────────▼───────────────────────▼──────────────────┐
│                   🔍 ADDITIONAL SERVICES                                    │
│  ┌────────────────────┐  ┌────────────────────┐                            │
│  │  ChromaDB (RAG)    │  │  OCR Service       │                            │
│  │  • Embeddings      │  │  • Tesseract       │                            │
│  │  • Semantic search │  │  • Azure DI        │                            │
│  └────────────────────┘  └────────────────────┘                            │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## SAS TOKEN SECURITY FLOW

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                   🔒 SAS TOKEN LIFECYCLE                                    │
└─────────────────────────────────────────────────────────────────────────────┘

    TIME: 10:00 AM                    10:30 AM                    11:01 AM
         │                                │                           │
         │                                │                           │
    ┌────▼────────────────────────┐      │                           │
    │ User requests download      │      │                           │
    │ GET /download-invoice/9     │      │                           │
    └────┬────────────────────────┘      │                           │
         │                                │                           │
    ┌────▼────────────────────────┐      │                           │
    │ Backend generates SAS       │      │                           │
    │ Expires: 11:00 AM           │      │                           │
    │ ┌─────────────────────────┐ │      │                           │
    │ │ URL + Token             │ │      │                           │
    │ │ ?se=2025-10-03T11:00:00Z│ │      │                           │
    │ └─────────────────────────┘ │      │                           │
    └────┬────────────────────────┘      │                           │
         │                                │                           │
    ┌────▼────────────────────────┐      │                           │
    │ Return to frontend          │      │                           │
    │ {"download_url": "..."}     │      │                           │
    └────┬────────────────────────┘      │                           │
         │                                │                           │
    ┌────▼────────────────────────┐ ┌────▼────────────────────┐ ┌───▼──────────────┐
    │ ✅ User downloads           │ │ ✅ User downloads       │ │ ❌ Token EXPIRED │
    │    (10:00 - 11:00 valid)    │ │    (still valid)        │ │    Access denied │
    └─────────────────────────────┘ └─────────────────────────┘ └──────────────────┘
                                                                          │
                                                                          │
                                                                 ┌────────▼──────────┐
                                                                 │ User must request │
                                                                 │ NEW URL from      │
                                                                 │ backend           │
                                                                 └───────────────────┘
```

---

## DATA REDUNDANCY & BACKUP

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     💾 DATA REDUNDANCY LAYERS                               │
└─────────────────────────────────────────────────────────────────────────────┘

    PRIMARY COPY              METADATA COPY          BACKUP COPY (Optional)
         │                         │                        │
    ┌────▼─────────┐         ┌────▼─────────┐       ┌─────▼────────┐
    │ Azure Blob   │         │ PostgreSQL   │       │ Azure Blob   │
    │ Storage      │         │ Database     │       │ (GRS)        │
    ├──────────────┤         ├──────────────┤       ├──────────────┤
    │ LRS:         │         │ Local:       │       │ GRS:         │
    │ 3 copies     │         │ 1 copy       │       │ 6 copies     │
    │ Same region  │         │ PostgreSQL   │       │ 2 regions    │
    │              │         │ backup       │       │              │
    │ 📁 Files:    │         │ 📊 Metadata: │       │ 🌍 Geo:      │
    │ - uuid1.png  │         │ - filename   │       │ - Southeast  │
    │ - uuid2.png  │         │ - file_path  │       │   Asia       │
    │ - uuid3.png  │         │ - date       │       │ - East Asia  │
    │              │         │ - type       │       │              │
    │ Cost:        │         │ Cost:        │       │ Cost:        │
    │ $0.02/GB     │         │ Free         │       │ $0.04/GB     │
    └──────────────┘         └──────────────┘       └──────────────┘
         ↑                         ↑                        ↑
         │                         │                        │
    Fast access            Fast queries           Disaster recovery
    Direct download        Filtering/search       Regional failover
```

---

## PERFORMANCE COMPARISON

```
┌─────────────────────────────────────────────────────────────────────────────┐
│          ⚡ DOWNLOAD PERFORMANCE: Local vs Azure                            │
└─────────────────────────────────────────────────────────────────────────────┘

    LOCAL STORAGE (via Backend)
    ────────────────────────────────
    User → Backend → File System → Backend → User
           ↑                               ↑
           Read file (10-50ms)             Stream (limited by server upload speed)
           
    Total: 100-500ms for 1MB file
    Bottleneck: Server bandwidth
    Concurrent users: Limited by server resources
    
    
    AZURE STORAGE (Direct Download)
    ────────────────────────────────
    User → Azure CDN → User
           ↑
           Global edge servers (5-20ms)
    
    Total: 50-200ms for 1MB file
    Bottleneck: User internet speed
    Concurrent users: Unlimited (Azure handles)
    
    
    ⚡ SPEED COMPARISON:
    ┌─────────┬──────────┬──────────┬──────────┐
    │ Size    │ Local    │ Azure    │ Winner   │
    ├─────────┼──────────┼──────────┼──────────┤
    │ 100 KB  │ 50ms     │ 30ms     │ Azure    │
    │ 1 MB    │ 200ms    │ 80ms     │ Azure    │
    │ 10 MB   │ 2s       │ 500ms    │ Azure    │
    │ 100 MB  │ 20s      │ 3s       │ Azure    │
    └─────────┴──────────┴──────────┴──────────┘
```

---

## API REQUEST/RESPONSE EXAMPLES

```json
═══════════════════════════════════════════════════════════════
1️⃣ UPLOAD REQUEST
═══════════════════════════════════════════════════════════════

POST /chat/upload
Content-Type: multipart/form-data

file=@invoice.png

───────────────────────────────────────────────────────────────

RESPONSE:
{
  "success": true,
  "document_id": 9,
  "filename": "invoice.png",
  "invoice_type": "general",
  "azure_url": "https://storage.blob.core.windows.net/chat-documents/session_abc/uuid.png",
  "document_info": {
    "invoice_id": "INV-001",
    "serial_no": "01ABC/2024"
  },
  "seller_info": {
    "name": "Công ty ABC",
    "mst_tax_code": "0123456789"
  },
  "payment_summary": {
    "total_payment": "1.500.000"
  }
}


═══════════════════════════════════════════════════════════════
2️⃣ LIST REQUEST
═══════════════════════════════════════════════════════════════

GET /chat/list-invoices?limit=5

───────────────────────────────────────────────────────────────

RESPONSE:
{
  "success": true,
  "count": 5,
  "invoices": [
    {
      "id": 10,
      "filename": "invoice-2024.png",
      "invoice_type": "general",
      "uploaded_at": "2025-10-03T20:46:37",
      "session_id": "17ae1e1a05f85ebe",
      "download_url": "https://storage.blob.core.windows.net/chat-documents/session_17ae/uuid.png?sv=2021-06-08&se=2025-10-04T20:46:37Z&sr=b&sp=r&sig=ABC123..."
    },
    {
      "id": 9,
      "filename": "hoa-don-ban-hang.png",
      "invoice_type": "food_service",
      "uploaded_at": "2025-10-03T20:44:49",
      "session_id": "6b2075ed012de3cc",
      "download_url": "https://storage.blob.core.windows.net/chat-documents/session_6b20/uuid.png?sv=2021-06-08&se=2025-10-04T20:44:49Z&sr=b&sp=r&sig=DEF456..."
    }
  ]
}


═══════════════════════════════════════════════════════════════
3️⃣ DOWNLOAD REQUEST
═══════════════════════════════════════════════════════════════

GET /chat/download-invoice/9

───────────────────────────────────────────────────────────────

RESPONSE:
{
  "success": true,
  "document_id": 9,
  "filename": "hoa-don-ban-hang.png",
  "invoice_type": "food_service",
  "download_url": "https://storage.blob.core.windows.net/chat-documents/session_6b20/uuid.png?sv=2021-06-08&se=2025-10-03T21:46:37Z&sr=b&sp=r&sig=XYZ789...",
  "expires_in": "1 hour"
}


═══════════════════════════════════════════════════════════════
4️⃣ PREVIEW REQUEST
═══════════════════════════════════════════════════════════════

POST /chat/get-invoice-content/9

───────────────────────────────────────────────────────────────

RESPONSE:
{
  "success": true,
  "document_id": 9,
  "filename": "hoa-don-ban-hang.png",
  "content_type": "image/png",
  "size": 163176,
  "content_base64": "iVBORw0KGgoAAAANSUhEUgAAB4AAAASwCAYAAABCp...",
  "data_url": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAB4..."
}

Frontend usage:
<img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAB4..." />
```

---

**🎯 Tóm tắt:** Hệ thống có đầy đủ APIs để upload, list, download, preview invoices từ Azure Storage với SAS token security!
